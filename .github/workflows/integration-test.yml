name: Integration Test Analysis

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    # Only run when @integration_test is mentioned in PR comments
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@integration_test')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@integration_test'))

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr;
            if (context.eventName === 'issue_comment') {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              const prNumber = context.issue.number;
              pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
            } else {
              pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              });
            }
            return {
              ref: pr.data.head.ref,
              sha: pr.data.head.sha,
              base: pr.data.base.ref,
              number: pr.data.number
            };

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ fromJson(steps.pr.outputs.result).ref }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Integration Test Analysis
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are performing integration test analysis for PR #${{ fromJson(steps.pr.outputs.result).number }}.

            Your task:
            1. Analyze the code changes in this PR by comparing with the base branch (${{ fromJson(steps.pr.outputs.result).base }})
            2. Identify all modified/added functions, classes, and methods
            3. Search the entire codebase to find all existing usages of the changed code
            4. Analyze whether the changes could break existing functionality
            5. Create or update integration tests to verify that existing usages still work correctly
            6. Commit any new or updated test files directly to this branch

            Requirements:
            - Focus on integration tests that verify interactions between components
            - Test real-world usage scenarios found in the codebase
            - If tests already exist, update them to cover the changes
            - If no tests exist, create new test files following the project's testing patterns
            - Include clear test names that describe what behavior is being verified
            - Add assertions for both success cases and edge cases

            After analysis, commit your changes with a message like:
            "Add integration tests for [changed components]"

            DO NOT create a pull request. Commit directly to the current branch.
