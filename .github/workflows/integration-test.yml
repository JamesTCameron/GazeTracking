name: Integration Test Analysis

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    # Only run when @integration_test is mentioned in PR comments
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@integration_test')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@integration_test'))

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr;
            if (context.eventName === 'issue_comment') {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              const prNumber = context.issue.number;
              pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
            } else {
              pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              });
            }
            return {
              ref: pr.data.head.ref,
              sha: pr.data.head.sha,
              base: pr.data.base.ref,
              number: pr.data.number
            };

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = context.payload.comment.id;
            if (commentId) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                content: 'rocket'
              });
            }

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ fromJson(steps.pr.outputs.result).ref }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Integration Test Analysis
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            REPOSITORY: ${{ github.repository }}
            PR NUMBER: ${{ fromJson(steps.pr.outputs.result).number }}
            BASE BRANCH: ${{ fromJson(steps.pr.outputs.result).base }}
            PR BRANCH: ${{ fromJson(steps.pr.outputs.result).ref }}

            You are performing automated integration test analysis for this pull request.

            CRITICAL INSTRUCTIONS:
            1. Use git to compare this PR branch with the base branch to see what changed
            2. Use Grep and Read tools to search the codebase for usages of changed functions/classes
            3. Use Write tool to create test files (e.g., tests/integration_test_<component>.py)
            4. Use Bash tool with git commands to add and commit the test files
            5. Leave a comment on the PR summarizing what you tested

            STEP-BY-STEP PROCESS:
            - Run: git diff ${{ fromJson(steps.pr.outputs.result).base }}...${{ fromJson(steps.pr.outputs.result).ref }}
            - Identify changed functions, classes, methods
            - Search codebase for usages with Grep
            - Create integration test files that verify existing usages still work
            - Commit with: git add tests/ && git commit -m "Add integration tests" && git push
            - Comment on PR #${{ fromJson(steps.pr.outputs.result).number }} with summary

            You MUST create test files and commit them. Even if the changes seem small, create basic integration tests.
          claude_args: |
            --allowedTools Bash,Read,Write,Grep,Glob
